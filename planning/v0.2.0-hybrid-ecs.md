# v0.2.0 - Hybrid ECS Architecture

**Status:** ✅ Implemented  
**Goal:** Migrate from legacy OOP "spaghetti" architecture to a maintainable Hybrid Entity-Component-System (ECS) with flat data storage and OOP systems using Template Method and Strategy patterns.

## 1. The Boardroom (Alignment Phase)

**Attendees:** Systems Architect, Logic Engineer, Frontend Specialist.

*   **Systems Architect:** "The current codebase has grown into unmaintainable OOP spaghetti. Deep nesting in `types.ts`, tightly coupled `engine/` modules, components scattered everywhere. We need a complete architectural refactor."
*   **Logic Engineer:** "I've been looking at ECS patterns. Pure ECS is great for games but feels overkill for our UI-heavy app. What about a hybrid approach? Flat data like ECS, but proper OOP for the systems?"
*   **Frontend Specialist:** "I need predictable state updates and clear module boundaries. The current `GameState` is a nightmare to work with in React."
*   **Consensus:**
    *   **Architecture:** Hybrid ECS (flat `Record<EntityId, T>` data + OOP System classes)
    *   **Patterns:** Template Method for system lifecycle, Strategy for hot-swapping
    *   **Structure:** Feature-based folder organization
    *   **Action:** Complete rewrite of core engine, reorganize all components

## 2. Architecture Overview

### 2.1. Entity System
```typescript
// Simple string identifiers with type prefixes
type EntityId = string;  // e.g., "party:nva", "politician:de-croo"

// Flat component storage - O(1) lookups
type ComponentTable<T> = Record<EntityId, T>;
```

### 2.2. Core Components
| Component | Purpose | Key Fields |
|-----------|---------|------------|
| `Identity` | Who/what the entity is | `name`, `type`, `tags` |
| `Stats` | Numerical attributes | `nationalPolling`, `seats`, `momentum`, `charisma` |
| `Relations` | Entity relationships | `sentiment`, `memberOf`, `leaderOf`, `coalitionPartner` |
| `Resources` | Expendable assets | `money`, `politicalCapital`, `actionPoints` |
| `TransientStatus` | Temporary states | `modifiers`, `isInCrisis`, `isUnderCordonSanitaire` |

### 2.3. Domain Components
| Component | Purpose |
|-----------|---------|
| `PartyPlatform` | Policy positions, priority issues |
| `ConstituencyData` | Region, language, seats, population |
| `IssueData` | Category, salience, volatility |
| `BillData` | Legislation status, votes, sponsors |

### 2.4. System Architecture (Template Method Pattern)
```typescript
abstract class System implements ISystem {
  update(state: GameState): GameState {
    if (!this.validate(state)) return state;
    let s = this.preProcess(state);
    s = this.process(s);        // Abstract - subclass implements
    s = this.postProcess(s);
    return s;
  }
}
```

**System Classes:**
- `System` - Base class with template lifecycle
- `ActionSystem` - Processes player/AI actions with validation
- `PhaseTransitionSystem` - Handles game phase changes
- `CompositeSystem` - Runs multiple systems in sequence
- `ConditionalSystem` - Decorator for conditional execution

## 3. Implementation Details

### 3.1. New Folder Structure
```
src/
├── core/                    # Game engine (ECS)
│   ├── types.ts             # All type definitions
│   ├── System.ts            # Abstract base classes
│   ├── factories.ts         # Entity creation functions
│   ├── queries.ts           # Pure query functions
│   ├── index.ts             # Public API
│   └── systems/
│       ├── campaign.ts      # Campaign actions & AI
│       ├── election.ts      # D'Hondt allocation
│       ├── coalition.ts     # Formation & negotiation
│       └── governing.ts     # Crisis & legislation
├── features/                # UI by game feature
│   ├── campaign/
│   ├── election/
│   ├── coalition/
│   ├── governing/
│   ├── map/
│   └── politicians/
├── shared/                  # Reusable code
│   ├── components/
│   ├── hooks/
│   └── utils/
└── pages/                   # Page-level components
```

### 3.2. Key Files Created

**Core Engine:**
- `src/core/types.ts` - 400+ lines defining complete Hybrid ECS type system
- `src/core/System.ts` - Abstract base classes with Template Method pattern
- `src/core/factories.ts` - `createParty()`, `createPolitician()`, `createConstituency()`, `createIssue()`
- `src/core/queries.ts` - 50+ pure query functions (`getAllParties()`, `hasMajority()`, etc.)

**Systems:**
- `src/core/systems/campaign.ts` - Campaign actions, AI behavior, polling updates
- `src/core/systems/election.ts` - D'Hondt seat allocation, 5% threshold
- `src/core/systems/coalition.ts` - Cordon Sanitaire, friction calculation
- `src/core/systems/governing.ts` - Crisis triggers, bill voting, stability

### 3.3. Build Configuration
- Added `@/` path alias in `vite.config.ts` and `tsconfig.app.json`
- All imports now use `@/core`, `@/features/*`, `@/shared/*`

## 4. Migration Summary

### 4.1. Deleted (Legacy OOP)
```
src/types.ts          → src/core/types.ts
src/constants.ts      → Integrated into systems
src/actions.ts        → ActionSystem pattern
src/events.ts         → GameEvent type
src/engine/*          → src/core/systems/*
src/components/*      → src/features/*/components/
src/hooks/*           → src/shared/hooks/
```

### 4.2. Key Architectural Changes
| Before (OOP) | After (Hybrid ECS) |
|--------------|-------------------|
| Nested `GameState.parties[id].stats.polling` | Flat `state.components.stats[partyId].nationalPolling` |
| `engine/coalition.ts` functions | `CoalitionSystem` class with `processAction()` |
| Scattered `if/else` logic | Template Method lifecycle |
| Circular dependencies | Clean module boundaries |
| 7000+ lines of legacy code | 3500 lines of structured architecture |

## 5. Git Commits

| Hash | Message |
|------|---------|
| `c86610d` | feat(core): implement Hybrid ECS architecture |
| `f3c8717` | refactor(features): reorganize components by feature domain |
| `4a9d2d3` | refactor(shared): extract shared components and pages |
| `e2e8edf` | build: configure path aliases for new architecture |
| `2b82384` | refactor: remove legacy OOP architecture (BREAKING) |

## 6. Benefits Achieved

1. **O(1) Entity Lookups** - Flat `Record<EntityId, T>` instead of nested objects
2. **Testable Systems** - Pure `(GameState) => GameState` transformations
3. **Hot-Swappable** - `ISystem` interface enables Strategy pattern
4. **Clear Boundaries** - Feature folders, core engine, shared utilities
5. **Type Safety** - No `any` types, full TypeScript coverage
6. **Maintainable** - Template Method ensures consistent system behavior

## 7. Next Steps

- [ ] **UI Migration:** Update feature components to use new `GameState` type
- [ ] **State Initialization:** Create `createInitialState()` with Belgian party data
- [ ] **React Integration:** Build `useGameState()` hook with system dispatching
- [ ] **Testing:** Add unit tests for systems and queries
- [ ] **Persistence:** Implement save/load with new flat structure
